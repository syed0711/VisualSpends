<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendWise - Transaction View</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        nav { margin-bottom: 20px; }
        nav a { margin-right: 15px; text-decoration: none; color: #007bff; }
        nav a:hover { text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; cursor: pointer; }
        th:hover { background-color: #0056b3; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .loading { text-align: center; padding: 20px; font-style: italic; }
        .error-message { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="{{ url_for('index') }}">Upload New File</a>
            <a href="{{ url_for('view_data_page') }}">View Transactions</a>
            <a href="{{ url_for('dashboard_page') }}">Dashboard</a>
        </nav>
        <h1>Transaction Data</h1>
        <div id="table_container">
            <p class="loading">Loading transactions...</p>
            <table id="transactions_table" style="display:none;">
                <thead>
                    <tr>
                        <th data-sort="date">Date</th>
                        <th data-sort="description">Description</th>
                        <th data-sort="amount">Amount</th>
                        <th data-sort="category">Category</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
        <p id="error_message_area" class="error-message" style="display:none;"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.querySelector('#transactions_table tbody');
            const table = document.querySelector('#transactions_table');
            const loadingMessage = document.querySelector('.loading');
            const errorMessageArea = document.getElementById('error_message_area');
            let currentSortColumn = null;
            let sortAscending = true;
            let transactionsData = [];

            function displayError(message) {
                loadingMessage.style.display = 'none';
                table.style.display = 'none';
                errorMessageArea.textContent = message;
                errorMessageArea.style.display = 'block';
            }

            function renderTable(data) {
                tableBody.innerHTML = ''; // Clear existing rows
                if (!data || data.length === 0) {
                    loadingMessage.textContent = 'No transactions found.';
                    loadingMessage.style.display = 'block'; // Ensure it's visible
                    table.style.display = 'none';
                    errorMessageArea.style.display = 'none';
                    return;
                }

                data.forEach(tx => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = tx.date || 'N/A';
                    row.insertCell().textContent = tx.description || 'N/A';
                    const amountCell = row.insertCell();
                    amountCell.textContent = typeof tx.amount === 'number' ? tx.amount.toFixed(2) : 'N/A';
                    amountCell.style.textAlign = 'right';
                    row.insertCell().textContent = tx.category || 'N/A';
                });
                loadingMessage.style.display = 'none';
                table.style.display = 'table';
                errorMessageArea.style.display = 'none';
            }

            function sortData(column) {
                if (currentSortColumn === column) {
                    sortAscending = !sortAscending;
                } else {
                    currentSortColumn = column;
                    sortAscending = true;
                }

                transactionsData.sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];

                    if (column === 'amount') {
                        valA = parseFloat(valA);
                        valB = parseFloat(valB);
                    } else if (column === 'date') {
                        // Basic date sort, assumes YYYY-MM-DD or similar sortable format
                        // More robust date parsing might be needed for other formats.
                        try {
                            valA = new Date(valA);
                            valB = new Date(valB);
                            if (isNaN(valA.getTime()) || isNaN(valB.getTime())) { // Handle invalid dates
                                valA = String(a[column]); // Fallback to string sort for invalid dates
                                valB = String(b[column]);
                            }
                        } catch (e) { // Fallback if Date conversion fails
                             valA = String(a[column]);
                             valB = String(b[column]);
                        }
                    } else { // String comparison
                        valA = String(valA || "").toLowerCase(); // Handle null/undefined for strings
                        valB = String(valB || "").toLowerCase();
                    }

                    if (valA < valB) return sortAscending ? -1 : 1;
                    if (valA > valB) return sortAscending ? 1 : -1;
                    return 0;
                });
                renderTable(transactionsData);
            }

            fetch('/api/transactions')
                .then(response => {
                    if (!response.ok) {
                        // Try to get error message from response body if possible
                        return response.json().then(errData => {
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errData.error || response.statusText}`);
                        }).catch(() => { // Fallback if response body is not JSON or no specific error message
                            throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Assuming data is the array of transactions, or an object like {"error": "message"}
                    if (data.error) { // Check if the JSON response itself contains an error key
                         displayError(`Error loading transactions: ${data.error}`);
                         return;
                    }
                    transactionsData = data; // Expecting data to be an array of transactions
                    renderTable(transactionsData);
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                    displayError(`Failed to load transactions. ${error.message}`);
                });

            document.querySelectorAll('#transactions_table thead th').forEach(th => {
                th.addEventListener('click', () => {
                    const columnKey = th.dataset.sort;
                    if (columnKey) {
                        sortData(columnKey);
                    }
                });
            });
        });
    </script>
</body>
</html>
